<script src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.6/dist/htmx.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
/* Loading animations */
.typing-bubble {
  display: flex;
  align-items: center;
  gap: 4px;
}

.typing-dot {
  width: 6px;
  height: 6px;
  background-color: #6b7280;
  border-radius: 50%;
  animation: typing 1.4s infinite ease-in-out both;
}

.typing-dot:nth-child(1) {
  animation-delay: -0.32s;
}

.typing-dot:nth-child(2) {
  animation-delay: -0.16s;
}

@keyframes typing {
  0%, 80%, 100% { 
    transform: scale(0);
  } 
  40% { 
    transform: scale(1);
  }
}

.ai-avatar-container img, .logo-loading {
  width: 32px;
  height: 32px;
}

.ai-avatar-container {
  display: flex;
  align-items: flex-start;
  justify-content: center;
  margin-top: 4px;
}

/* Styled code blocks */
pre {
  background-color: #f6f8fa !important;
  border: 1px solid #d1d9e0 !important;
  border-radius: 6px !important;
  padding: 16px !important;
  margin: 16px 0 !important;
  white-space: pre !important;
  font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', 'Source Code Pro', monospace !important;
  font-size: 14px !important;
  line-height: 1.45 !important;
  color: #24292f !important;
  overflow-x: auto !important;
  max-width: 100% !important;
}

pre code {
  background: none !important;
  padding: 0 !important;
  border: none !important;
  font-size: inherit !important;
}

/* Inline code */
code {
  background-color: #f1f3f4 !important;
  color: #333 !important;
  padding: 2px 4px !important;
  border-radius: 3px !important;
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace !important;
  font-size: 13px !important;
  white-space: pre-wrap !important;
  word-wrap: break-word !important;
}

/* Table styling */
table {
  border-collapse: collapse !important;
  width: 100% !important;
  margin: 16px 0 !important;
  font-size: 14px !important;
}

table th, table td {
  border: 1px solid #d1d5db !important;
  padding: 8px 12px !important;
  text-align: left !important;
}

table th {
  background-color: #f9fafb !important;
  font-weight: 600 !important;
  color: #374151 !important;
}

table tr:nth-child(even) {
  background-color: #f9fafb !important;
}

table tr:hover {
  background-color: #f3f4f6 !important;
}

/* Model dropdown styling */
.model-dropdown {
  bottom: 100%;
  left: 0;
  z-index: 50;
}

/* Logo rotation animation (for non-loading state) */
@keyframes logoRotate {
  0% { transform: rotate(0deg); }
  25% { transform: rotate(180deg); }
  50% { transform: rotate(180deg); }
  75% { transform: rotate(-180deg); }
  100% { transform: rotate(-180deg); }
}

/* Logo loading animation (shrink to grow + rotation) */
@keyframes logoLoadingAnimation {
  0% { transform: rotate(0deg) scale(1); }
  12.5% { transform: rotate(45deg) scale(0); }
  25% { transform: rotate(180deg) scale(1); }
  37.5% { transform: rotate(225deg) scale(0); }
  50% { transform: rotate(180deg) scale(1); }
  62.5% { transform: rotate(-135deg) scale(0); }
  75% { transform: rotate(-180deg) scale(1); }
  87.5% { transform: rotate(-225deg) scale(0); }
  100% { transform: rotate(-180deg) scale(1); }
}

/* Active loading: shrink/grow + rotation */
.ai-loading .logo-loading {
  animation: logoLoadingAnimation 2s infinite;
}

/* Not actively loading: just rotation */
.logo-loading {
  animation: logoRotate 3s infinite;
}
</style>

<script>
let selectedModel = 'capmap'; // Default to CapMap
let dropdownOpen = false;

function toggleModelDropdown() {
  const dropdown = document.getElementById('model-dropdown');
  dropdownOpen = !dropdownOpen;
  dropdown.classList.toggle('hidden', !dropdownOpen);
}

function selectModel(modelKey, modelName) {
  selectedModel = modelKey;
  document.getElementById('selected-model').textContent = modelName;
  document.getElementById('model-input').value = modelKey;
  toggleModelDropdown();
}

// Close dropdown when clicking outside
document.addEventListener('click', function(e) {
  const dropdown = document.getElementById('model-dropdown');
  const button = document.getElementById('model-selector-btn');
  if (dropdownOpen && !dropdown.contains(e.target) && !button.contains(e.target)) {
    dropdownOpen = false;
    dropdown.classList.add('hidden');
  }
});

// Initialize form submission handler
document.addEventListener('DOMContentLoaded', function() {
  const form = document.querySelector('form');
  if (form) {
    form.addEventListener('submit', function(e) {
      // Clear loading states from all previous AI messages
      clearPreviousLoadingStates();

      // Clear the input field after sending
      setTimeout(() => {
        const messageInput = document.getElementById('message-input');
        if (messageInput) {
          messageInput.value = '';
        }
      }, 100);
    });
  }
});

function clearPreviousLoadingStates() {
  // Hide all existing AI avatars (both loading and static ones)
  const allAvatars = document.querySelectorAll('.ai-avatar-container');
  allAvatars.forEach(avatar => {
    // Remove loading classes
    avatar.classList.remove('ai-loading');
    const img = avatar.querySelector('img');
    if (img) {
      img.classList.remove('logo-loading');
      // Hide the entire avatar container
      avatar.style.display = 'none';
    }
  });
}

function startAIStream(aiResponse, aiId) {
  const aiContent = document.getElementById(aiId).querySelector('.text-gray-900 div');
  const avatarContainer = document.getElementById(aiId).querySelector('.ai-avatar-container');

  // Make sure current avatar is visible
  avatarContainer.style.display = 'flex';

  const eventSource = new EventSource('/chat/stream/' + aiId);
  let accumulatedContent = '';
  aiContent.innerHTML = '';

  eventSource.onmessage = function(event) {
    if (avatarContainer.classList.contains('ai-loading')) {
      avatarContainer.classList.remove('ai-loading');
      // Keep the logo but remove loading animation
      const img = avatarContainer.querySelector('img');
      if (img && img.classList.contains('logo-loading')) {
        img.classList.remove('logo-loading');
      }
    }
    accumulatedContent += event.data;
    // Show accumulated content as HTML
    aiContent.innerHTML = accumulatedContent;
  };

  eventSource.addEventListener('complete', function(event) {
    // Final render to ensure proper HTML
    aiContent.innerHTML = accumulatedContent;
    // Keep the avatar visible as this is now the latest response
    // (Previous ones were already hidden by clearPreviousLoadingStates)
    eventSource.close();
  });

  eventSource.onerror = function(error) {
    console.error('SSE error:', error);
    avatarContainer.classList.remove('ai-loading');
    // Remove loading animation on error
    const img = avatarContainer.querySelector('img');
    if (img && img.classList.contains('logo-loading')) {
      img.classList.remove('logo-loading');
    }
    // Keep avatar visible even on error as this is the latest response
    aiContent.textContent = 'Error loading response';
    eventSource.close();
  };
}




</script>

<body class="min-h-screen bg-white flex">

<%= erb :sidebar, layout: false %>
<%= erb :_agent_sidebar, layout: false %>

<!-- Main content -->
<div class="flex-1 flex flex-col">

<!-- Header with sidebar toggle -->
<div class="bg-white px-4 py-4">
  <div class="flex items-center justify-between">
    <div class="flex items-center">
      <button class="p-2 mr-2 bg-white border border-gray-200 hover:border-gray-300 hover:shadow-md rounded-xl text-gray-700 transition-all duration-200" 
              hx-post="/toggle-left-sidebar" 
              hx-target="#sidebar"
              hx-swap="outerHTML"
              title="Chat History">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
      </button>
    </div>
    <button class="flex items-center gap-3 p-1.5 pr-4 bg-white border border-gray-200 hover:border-gray-300 hover:shadow-md rounded-xl transition-all duration-200 group shadow-sm" 
            hx-post="/toggle-right-sidebar" 
            hx-target="#agent-sidebar"
            hx-swap="outerHTML">
      <div class="p-2 bg-black rounded-lg text-white group-hover:scale-105 transition-transform duration-200 shadow-sm">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
        </svg>
      </div>
      <div class="text-left">
        <div class="text-sm font-bold text-gray-900 leading-none">Agent Models</div>
        <div class="text-[10px] text-gray-500 font-medium mt-1">VC Copilot Suite</div>
      </div>
    </button>
  </div>
</div>

<!-- Message Container -->
<div class="flex-1 overflow-y-auto px-4 py-6">
  <div class="container max-w-3xl mx-auto space-y-4">
    <% if @show_welcome || locals[:messages].nil? || locals[:messages].empty? %>
      <div id="welcome-section">
        <%= erb :_welcome, layout: false %>
      </div>
    <% end %>
    
    <!-- Existing Messages -->
    <% if locals[:messages] && locals[:messages].any? %>
      <% locals[:messages].each do |message| %>
        <% if message[:role] == 'user' %>
          <div class="flex justify-end mb-4">
            <div class="bg-black text-white p-4 rounded-2xl rounded-br-md max-w-2xl">
              <% 
                parts = JSON.parse(message[:parts])
                text_content = parts.map { |part| part['text'] }.compact.join(' ')
                # Only convert newlines that aren't part of tables
                unless text_content.include?('|')
                  text_content = text_content.gsub("\n", "\n\n")
                end
                renderer = Redcarpet::Render::HTML.new(filter_html: true, no_styles: true, safe_links_only: true)
                markdown = Redcarpet::Markdown.new(renderer, autolink: true, tables: true, fenced_code_blocks: true, space_after_headers: true)
                rendered_html = markdown.render(text_content)
              %>
              <%= rendered_html.gsub('&lt;', '<').gsub('&gt;', '>').gsub('&amp;', '&') %>
            </div>
          </div>
        <% elsif message[:role] == 'assistant' %>
          <div class="flex justify-start mb-6">
            <div class="flex items-start gap-3 max-w-2xl">
              <div class="ai-avatar-container" style="display: none;">
                <img src="/logo.svg" alt="AI">
              </div>
              <div class="text-gray-900 flex-1 min-w-0 break-words">
                <div>
                  <% 
                    parts = JSON.parse(message[:parts])
                    text_content = parts.map { |part| part['text'] }.compact.join(' ')
                    # Only convert newlines that aren't part of tables
                    unless text_content.include?('|')
                      text_content = text_content.gsub("\n", "\n\n")
                    end
                    renderer = Redcarpet::Render::HTML.new(filter_html: true, no_styles: true, safe_links_only: true)
                    markdown = Redcarpet::Markdown.new(renderer, autolink: true, tables: true, fenced_code_blocks: true, space_after_headers: true)
                    rendered_html = markdown.render(text_content)
                  %>
                  <%= rendered_html.gsub('&lt;', '<').gsub('&gt;', '>').gsub('&amp;', '&') %>
                </div>
              </div>
            </div>
          </div>
        <% end %>
      <% end %>
    <% end %>
    <!-- New messages will be inserted here -->
  </div>
</div>

<!-- Input Form - Sticky at bottom -->
<div class="sticky bottom-0 bg-white px-4 py-6">
  <div class="max-w-3xl mx-auto flex items-center gap-3">
    
    <!-- Model Selector -->
    <div class="relative">
      <button type="button"
              id="model-selector-btn"
              class="flex items-center gap-2 px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-gray-700 transition-colors duration-200 text-sm font-medium"
              onclick="toggleModelDropdown()">
        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
        </svg>
        <span id="selected-model">CapMap</span>
        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
        </svg>
      </button>

      <!-- Dropdown Menu -->
      <div id="model-dropdown"
           class="hidden absolute bottom-full left-0 mb-2 w-64 bg-white border border-gray-200 rounded-xl shadow-xl overflow-hidden z-50">
        <div class="py-1 max-h-80 overflow-y-auto">
          <% [
            ['capmap', 'CapMap', true],
            ['claude-opus-4.5', 'Claude Opus 4.5', false],
            ['claude-sonnet-4.5', 'Claude Sonnet 4.5', false],
            ['deepseek-v3.2', 'DeepSeek v3.2', false],
            ['gemini-3-pro', 'Gemini 3 Pro', false],
            ['gemini-2.5-flash', 'Gemini 2.5 Flash', false],
            ['gpt-5.2', 'GPT-5.2', false],
            ['perplexity-sonar-pro-search', 'Perplexity Sonar Pro', false],
            ['perplexity-sonar-reasoning-pro', 'Perplexity Reasoning', false],
            ['qwen3-VL-thinking-235B', 'Qwen3 VL Thinking', false],
            ['grok-4.1-fast', 'Grok 4.1 Fast', false],
            ['kimi-k2-thinking', 'Kimi K2 Thinking', false],
            ['glm-4.6', 'GLM-4.6', false]
          ].each do |id, name, is_selected| %>
          <button type="button" 
                  class="w-full text-left px-4 py-2.5 text-sm hover:bg-gray-50 flex items-center justify-between group <%= is_selected ? 'text-blue-600 font-medium' : 'text-gray-700' %>"
                  onclick="selectModel('<%= id %>', '<%= name %>')">
            <span><%= name %></span>
            <% if is_selected %>
                <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
            <% end %>
          </button>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Chat Form -->
    <form class="relative flex-1"
          hx-post="/chat/messages"
          hx-target=".container"
          hx-swap="beforeend"
          hx-on::after-request="document.getElementById('welcome-section')?.remove(); document.getElementById('message-input').value = ''">
      <input class="w-full pl-5 pr-14 py-3.5 border border-gray-300 rounded-full bg-white text-gray-700 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-200 focus:border-gray-400 shadow-sm text-base transition-shadow duration-200"
             name="message"
             type="text"
             placeholder="Send a message..."
             id="message-input"
             autocomplete="off"/>
      <input type="hidden" name="model" id="model-input" value="capmap"/>
      <button class="absolute right-2 top-1/2 transform -translate-y-1/2 w-9 h-9 bg-black hover:scale-105 active:scale-95 text-white rounded-full flex items-center justify-center transition-all duration-200 shadow-md"
              type="submit"
              id="send-button">
        <svg class="w-4 h-4 ml-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/>
        </svg>
      </button>

      <!-- Stop Button (Hidden by default) -->
      <button class="absolute right-2 top-1/2 transform -translate-y-1/2 w-9 h-9 bg-black hover:bg-gray-800 text-white rounded-full flex items-center justify-center transition-all duration-200 shadow-md hidden"
              type="button"
              onclick="stopGeneration()"
              id="stop-button">
        <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 24 24">
          <path d="M6 6h12v12H6z"/>
        </svg>
      </button>
    </form>
  </div>
</div>

<script>
let currentEventSource = null;
let statusInterval = null;

function toggleModelDropdown() {
    const dropdown = document.getElementById('model-dropdown');
    dropdown.classList.toggle('hidden');
}

function selectModel(id, name) {
    // Update hidden input
    document.getElementById('model-input').value = id;
    
    // Update button text
    document.getElementById('selected-model').textContent = name;
    
    // Update selected state in dropdown (visual only, quick toggle)
    const buttons = document.querySelectorAll('#model-dropdown button');
    buttons.forEach(btn => {
        const span = btn.querySelector('span');
        const isSelected = span.textContent === name;
        
        btn.className = `w-full text-left px-4 py-2.5 text-sm hover:bg-gray-50 flex items-center justify-between group ${isSelected ? 'text-blue-600 font-medium' : 'text-gray-700'}`;
        
        // Remove existing checkmark if any
        const existingCheck = btn.querySelector('svg');
        if (existingCheck) existingCheck.remove();
        
        // Add checkmark if selected
        if (isSelected) {
            btn.innerHTML = `<span>${name}</span><svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>`;
        } else {
             btn.innerHTML = `<span>${span.textContent}</span>`;
        }
    });

    // Close dropdown
    document.getElementById('model-dropdown').classList.add('hidden');
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
    const dropdown = document.getElementById('model-dropdown');
    const button = document.getElementById('model-selector-btn');
    
    if (!dropdown.classList.contains('hidden') && 
        !button.contains(event.target) && 
        !dropdown.contains(event.target)) {
        dropdown.classList.add('hidden');
    }
});

// Stop generation logic
function stopGeneration() {
  if (currentEventSource) {
    currentEventSource.close();
    currentEventSource = null;
  }
  
  if (statusInterval) {
    clearInterval(statusInterval);
    statusInterval = null;
  }
  
  // Toggle buttons back
  document.getElementById('stop-button').classList.add('hidden');
  document.getElementById('send-button').classList.remove('hidden');
  
  // Clean up any remaining loading indicators
  const dots = document.querySelectorAll('.typing-bubble');
  dots.forEach(d => d.parentElement.innerHTML = '<span class="text-xs text-gray-500 italic">Generation stopped.</span>');
}

function startAIStream(aiResponse, aiId) {
  // Show Stop button, hide Send button
  document.getElementById('send-button').classList.add('hidden');
  document.getElementById('stop-button').classList.remove('hidden');

  const container = document.getElementById(aiId);
  if (!container) return; // Safety check

  // ---------------------------------------------------------
  // CLIENT-SIDE PATCH FOR LEGACY SERVER HTML (No Restart Fix)
  // ---------------------------------------------------------
  
  // 1. Remove rotating animation classes immediately
  const avatarContainer = container.querySelector('.ai-avatar-container');
  if (avatarContainer) {
      avatarContainer.classList.remove('ai-loading');
      const img = avatarContainer.querySelector('img');
      if (img) img.classList.remove('logo-loading');
      avatarContainer.style.display = 'flex';
  }

  // 2. Replace "AI is thinking..." with new Status UI if present
  const oldIndicator = container.querySelector('.typing-indicator');
  let statusText = null;

  if (oldIndicator) {
      // We are running on old server HTML. Replace it dynamically.
      const wrapper = oldIndicator.parentElement;
      wrapper.innerHTML = `
        <div class="inline-block px-4 py-3 bg-gray-100 rounded-2xl rounded-tl-none">
            <div class="flex items-center gap-3">
                <div class="typing-bubble">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
                <span class="text-xs font-medium text-gray-500 status-text">Analyzing Request...</span>
            </div>
        </div>
      `;
      // Re-query the new status text element
      statusText = wrapper.querySelector('.status-text');
  } else {
      // We might be on new HTML, start looking for status text normally
      statusText = container.querySelector('.status-text');
  }
  
  // ---------------------------------------------------------

  const aiContent = container.querySelector('.text-gray-900 div');

  // Start cycling status text
  const statuses = ["Analyzing Request...", "Searching Knowledge Base...", "Formulating Response...", "Thinking...", "Synthesizing Answer..."];
  let statusIndex = 0;
  
  // Update every 5 seconds as requested
  statusInterval = setInterval(() => {
    if (statusText) {
        statusIndex = (statusIndex + 1) % statuses.length;
        statusText.textContent = statuses[statusIndex];
    }
  }, 5000);

  const eventSource = new EventSource('/chat/stream/' + aiId);
  currentEventSource = eventSource;
  
  let accumulatedContent = '';
  let hasStarted = false;

  eventSource.onmessage = function(event) {
    if (!hasStarted) {
        // First token received: clear interval, clear placeholder, ready for text
        if (statusInterval) clearInterval(statusInterval);
        // Clear the entire wrapper logic we might have injected
        aiContent.innerHTML = ''; 
        hasStarted = true;
    }
    
    accumulatedContent += event.data;
    // Show accumulated content as HTML
    aiContent.innerHTML = accumulatedContent;
  };

  eventSource.addEventListener('complete', function(event) {
    aiContent.innerHTML = accumulatedContent;
    eventSource.close();
    currentEventSource = null;
    
    if (statusInterval) clearInterval(statusInterval);
    
    // Reset buttons
    document.getElementById('stop-button').classList.add('hidden');
    document.getElementById('send-button').classList.remove('hidden');
  });

  eventSource.onerror = function(error) {
    console.error('SSE error:', error);
    if (statusInterval) clearInterval(statusInterval);
    
    aiContent.textContent = 'Error loading response';
    eventSource.close();
    currentEventSource = null;
    
    document.getElementById('stop-button').classList.add('hidden');
    document.getElementById('send-button').classList.remove('hidden');
  };
}
</script>
  </div>
</div>

</div>

</body>