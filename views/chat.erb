<script src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.6/dist/htmx.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
/* Loading animations */
.typing-bubble {
  display: flex;
  align-items: center;
  gap: 4px;
}

.typing-dot {
  width: 6px;
  height: 6px;
  background-color: #6b7280;
  border-radius: 50%;
  animation: typing 1.4s infinite ease-in-out both;
}

.typing-dot:nth-child(1) {
  animation-delay: -0.32s;
}

.typing-dot:nth-child(2) {
  animation-delay: -0.16s;
}

@keyframes typing {
  0%, 80%, 100% { 
    transform: scale(0);
  } 
  40% { 
    transform: scale(1);
  }
}

.ai-avatar-container img, .logo-loading {
  width: 32px;
  height: 32px;
}

.ai-avatar-container {
  display: flex;
  align-items: flex-start;
  justify-content: center;
  margin-top: 4px;
}

/* Styled code blocks */
pre {
  background-color: #f6f8fa !important;
  border: 1px solid #d1d9e0 !important;
  border-radius: 6px !important;
  padding: 16px !important;
  margin: 16px 0 !important;
  white-space: pre !important;
  font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', 'Source Code Pro', monospace !important;
  font-size: 14px !important;
  line-height: 1.45 !important;
  color: #24292f !important;
  overflow-x: auto !important;
  max-width: 100% !important;
}

pre code {
  background: none !important;
  padding: 0 !important;
  border: none !important;
  font-size: inherit !important;
}

/* Inline code */
code {
  background-color: #f1f3f4 !important;
  color: #333 !important;
  padding: 2px 4px !important;
  border-radius: 3px !important;
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace !important;
  font-size: 13px !important;
  white-space: pre-wrap !important;
  word-wrap: break-word !important;
}

/* Table styling */
table {
  border-collapse: collapse !important;
  width: 100% !important;
  margin: 16px 0 !important;
  font-size: 14px !important;
}

table th, table td {
  border: 1px solid #d1d5db !important;
  padding: 8px 12px !important;
  text-align: left !important;
}

table th {
  background-color: #f9fafb !important;
  font-weight: 600 !important;
  color: #374151 !important;
}

table tr:nth-child(even) {
  background-color: #f9fafb !important;
}

table tr:hover {
  background-color: #f3f4f6 !important;
}

/* Model dropdown styling */
.model-dropdown {
  bottom: 100%;
  left: 0;
  z-index: 50;
}

/* Logo rotation animation (for non-loading state) */
@keyframes logoRotate {
  0% { transform: rotate(0deg); }
  25% { transform: rotate(180deg); }
  50% { transform: rotate(180deg); }
  75% { transform: rotate(-180deg); }
  100% { transform: rotate(-180deg); }
}

/* Logo loading animation (shrink to grow + rotation) */
@keyframes logoLoadingAnimation {
  0% { transform: rotate(0deg) scale(1); }
  12.5% { transform: rotate(45deg) scale(0); }
  25% { transform: rotate(180deg) scale(1); }
  37.5% { transform: rotate(225deg) scale(0); }
  50% { transform: rotate(180deg) scale(1); }
  62.5% { transform: rotate(-135deg) scale(0); }
  75% { transform: rotate(-180deg) scale(1); }
  87.5% { transform: rotate(-225deg) scale(0); }
  100% { transform: rotate(-180deg) scale(1); }
}

/* Active loading: shrink/grow + rotation */
.ai-loading .logo-loading {
  animation: logoLoadingAnimation 2s infinite;
}

/* Not actively loading: just rotation */
.logo-loading {
  animation: logoRotate 3s infinite;
}

/* ===== UPGRADE CELEBRATION ANIMATION ===== */

/* Blur the main content during animation */
.upgrade-blur {
  filter: blur(8px);
  transition: filter 0.5s ease;
}

/* The upgrade overlay */
.upgrade-overlay {
  position: fixed;
  inset: 0;
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(0, 0, 0, 0.3);
  backdrop-filter: blur(4px);
}

/* The premium ball */
.premium-ball {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 48px;
  font-weight: bold;
  color: white;
  text-shadow: 0 2px 10px rgba(0,0,0,0.3);
  box-shadow: 
    0 0 60px rgba(255, 215, 0, 0.6),
    0 0 120px rgba(255, 165, 0, 0.4),
    inset 0 -10px 30px rgba(0,0,0,0.2),
    inset 0 10px 30px rgba(255,255,255,0.3);
  animation: ball-spawn-expand 2.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
}

/* Golden ball for Advanced */
.premium-ball.golden {
  background: linear-gradient(135deg, #FFD700 0%, #FFA500 50%, #FF8C00 100%);
}

/* Diamond ball for Pro */
.premium-ball.diamond {
  background: linear-gradient(135deg, #E8F4FF 0%, #B8E0FF 25%, #FFFFFF 50%, #D4F1FF 75%, #A8D8FF 100%);
  box-shadow: 
    0 0 60px rgba(180, 220, 255, 0.8),
    0 0 120px rgba(135, 206, 250, 0.5),
    inset 0 -10px 30px rgba(100,150,200,0.2),
    inset 0 10px 30px rgba(255,255,255,0.8);
}

.premium-ball.diamond::before {
  content: '';
  position: absolute;
  width: 100%;
  height: 100%;
  border-radius: 50%;
  background: linear-gradient(45deg, transparent 40%, rgba(255,255,255,0.8) 50%, transparent 60%);
  animation: diamond-shimmer 2s infinite;
}

@keyframes diamond-shimmer {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Stage 1: Spawn and expand with rotation */
@keyframes ball-spawn-expand {
  0% {
    transform: scale(0) rotate(0deg);
    opacity: 0;
  }
  10% {
    opacity: 1;
  }
  100% {
    transform: scale(1.2) rotate(360deg);
    opacity: 1;
  }
}

/* Stage 2: Smash to bottom-left corner */
@keyframes ball-smash {
  0% {
    transform: scale(1.2) rotate(360deg);
  }
  50% {
    transform: scale(1.4) rotate(540deg) translate(-40vw, 35vh);
  }
  80% {
    transform: scale(0.4) rotate(720deg) translate(-45vw, 42vh);
  }
  100% {
    transform: scale(0.35) rotate(720deg) translate(-45vw, 42vh);
    opacity: 0;
  }
}

.premium-ball.smashing {
  animation: ball-smash 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
}

/* Impact flash on avatar */
@keyframes impact-flash {
  0% {
    box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.8);
    transform: scale(1);
  }
  50% {
    box-shadow: 0 0 40px 20px rgba(255, 215, 0, 0.6);
    transform: scale(1.3);
  }
  100% {
    box-shadow: 0 0 20px 5px rgba(255, 215, 0, 0.3);
    transform: scale(1);
  }
}

.avatar-impact {
  animation: impact-flash 0.5s ease-out forwards;
}

/* Premium avatar styles */
.avatar-golden {
  background: linear-gradient(135deg, #FFD700 0%, #FFA500 50%, #FF8C00 100%) !important;
  box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
}

.avatar-diamond {
  background: linear-gradient(135deg, #E8F4FF 0%, #B8E0FF 50%, #FFFFFF 100%) !important;
  box-shadow: 0 0 20px rgba(135, 206, 250, 0.5);
  color: #1a1a2e !important;
}
/* Upgrade CTA button shimmer */
.upgrade-cta-btn {
  position: relative;
  overflow: hidden;
}
.upgrade-cta-btn::after {
  content: '';
  position: absolute;
  top: 0;
  left: -75%;
  width: 50%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.25), transparent);
  animation: upgrade-shimmer 2.4s infinite;
}
@keyframes upgrade-shimmer {
  0%   { left: -75%; }
  60%  { left: 125%; }
  100% { left: 125%; }
}
</style>

<script>
let selectedModel = 'capmap'; // Default to CapMap
let dropdownOpen = false;

function toggleModelDropdown() {
  const dropdown = document.getElementById('model-dropdown');
  dropdownOpen = !dropdownOpen;
  dropdown.classList.toggle('hidden', !dropdownOpen);
}

function selectModel(modelKey, modelName) {
  selectedModel = modelKey;
  document.getElementById('selected-model').textContent = modelName;
  document.getElementById('model-input').value = modelKey;
  toggleModelDropdown();
}

// Close dropdown when clicking outside
document.addEventListener('click', function(e) {
  const dropdown = document.getElementById('model-dropdown');
  const button = document.getElementById('model-selector-btn');
  if (dropdownOpen && !dropdown.contains(e.target) && !button.contains(e.target)) {
    dropdownOpen = false;
    dropdown.classList.add('hidden');
  }
});

// Initialize form submission handler
document.addEventListener('DOMContentLoaded', function() {
  const form = document.querySelector('form');
  if (form) {
    form.addEventListener('submit', function(e) {
      // Clear loading states from all previous AI messages
      clearPreviousLoadingStates();

      // Clear the input field after sending
      setTimeout(() => {
        const messageInput = document.getElementById('message-input');
        if (messageInput) {
          messageInput.value = '';
        }
      }, 100);
    });
  }
});

function clearPreviousLoadingStates() {
  // Hide all existing AI avatars (both loading and static ones)
  const allAvatars = document.querySelectorAll('.ai-avatar-container');
  allAvatars.forEach(avatar => {
    // Remove loading classes
    avatar.classList.remove('ai-loading');
    const img = avatar.querySelector('img');
    if (img) {
      img.classList.remove('logo-loading');
      // Hide the entire avatar container
      avatar.style.display = 'none';
    }
  });
}

function startAIStream(aiResponse, aiId) {
  const aiContent = document.getElementById(aiId).querySelector('.text-gray-900 div');
  const avatarContainer = document.getElementById(aiId).querySelector('.ai-avatar-container');

  // Make sure current avatar is visible
  avatarContainer.style.display = 'flex';

  const eventSource = new EventSource('/chat/stream/' + aiId);
  let accumulatedContent = '';
  aiContent.innerHTML = '';

  eventSource.onmessage = function(event) {
    if (avatarContainer.classList.contains('ai-loading')) {
      avatarContainer.classList.remove('ai-loading');
      // Keep the logo but remove loading animation
      const img = avatarContainer.querySelector('img');
      if (img && img.classList.contains('logo-loading')) {
        img.classList.remove('logo-loading');
      }
    }
    accumulatedContent += event.data;
    // Show accumulated content as HTML
    aiContent.innerHTML = accumulatedContent;
  };

  eventSource.addEventListener('complete', function(event) {
    // Final render to ensure proper HTML
    aiContent.innerHTML = accumulatedContent;
    // Keep the avatar visible as this is now the latest response
    // (Previous ones were already hidden by clearPreviousLoadingStates)
    eventSource.close();
  });

  eventSource.onerror = function(error) {
    console.error('SSE error:', error);
    avatarContainer.classList.remove('ai-loading');
    // Remove loading animation on error
    const img = avatarContainer.querySelector('img');
    if (img && img.classList.contains('logo-loading')) {
      img.classList.remove('logo-loading');
    }
    // Keep avatar visible even on error as this is the latest response
    aiContent.textContent = 'Error loading response';
    eventSource.close();
  };
}




</script>

<body class="min-h-screen bg-white flex">

<%= erb :sidebar, layout: false %>
<%= erb :_agent_sidebar, layout: false %>

<!-- Main content -->
<div class="flex-1 flex flex-col">

<!-- Header with sidebar toggle -->
<div class="bg-white px-4 py-4">
  <div class="flex items-center justify-between">
    <div class="flex items-center">
      <button class="p-2 mr-2 bg-white border border-gray-200 hover:border-gray-300 hover:shadow-md rounded-xl text-gray-700 transition-all duration-200" 
              hx-post="/toggle-left-sidebar" 
              hx-target="#sidebar"
              hx-swap="outerHTML"
              title="Chat History">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
      </button>
    </div>
    <div class="flex items-center gap-2">
      <button class="flex items-center gap-3 p-1.5 pr-4 bg-white border border-gray-200 hover:border-gray-300 hover:shadow-md rounded-xl transition-all duration-200 group shadow-sm" 
              hx-post="/toggle-right-sidebar" 
              hx-target="#agent-sidebar"
              hx-swap="outerHTML">
        <div class="p-2 bg-black rounded-lg text-white group-hover:scale-105 transition-transform duration-200 shadow-sm">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
          </svg>
        </div>
        <div class="text-left">
          <div class="text-sm font-bold text-gray-900 leading-none">Agent Models</div>
          <div class="text-[10px] text-gray-500 font-medium mt-1">VC Copilot Suite</div>
        </div>
      </button>
      <button class="p-2 bg-white border border-gray-200 hover:border-gray-300 hover:shadow-md hover:bg-gray-50 rounded-xl text-gray-600 transition-all duration-200 shadow-sm group"
              title="Submit Feedback"
              onclick="document.getElementById('feedback-modal').classList.remove('hidden')">
        <svg class="w-5 h-5 group-hover:text-blue-600 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
        </svg>
      </button>
    </div>
  </div>
</div>

<!-- Message Container -->
<div class="flex-1 overflow-y-auto px-4 py-6">
  <div class="container max-w-3xl mx-auto space-y-4">
    <% if @show_welcome || locals[:messages].nil? || locals[:messages].empty? %>
      <div id="welcome-section">
        <%= erb :_welcome, layout: false %>
      </div>
    <% end %>
    
    <!-- Existing Messages -->
    <% if locals[:messages] && locals[:messages].any? %>
      <% locals[:messages].each do |message| %>
        <% if message[:role] == 'user' %>
          <div class="flex justify-end mb-4">
            <div class="bg-black text-white p-4 rounded-2xl rounded-br-md max-w-2xl">
              <% 
                parts = JSON.parse(message[:parts])
                text_content = parts.map { |part| part['text'] }.compact.join(' ')
                # Only convert newlines that aren't part of tables
                unless text_content.include?('|')
                  text_content = text_content.gsub("\n", "\n\n")
                end
                renderer = Redcarpet::Render::HTML.new(filter_html: true, no_styles: true, safe_links_only: true)
                markdown = Redcarpet::Markdown.new(renderer, autolink: true, tables: true, fenced_code_blocks: true, space_after_headers: true)
                rendered_html = markdown.render(text_content)
              %>
              <%= rendered_html.gsub('&lt;', '<').gsub('&gt;', '>').gsub('&amp;', '&') %>
            </div>
          </div>
        <% elsif message[:role] == 'assistant' %>
          <div class="flex justify-start mb-6">
            <div class="flex items-start gap-3 max-w-2xl">
              <div class="ai-avatar-container" style="display: none;">
                <img src="/logo.svg" alt="AI">
              </div>
              <div class="text-gray-900 flex-1 min-w-0 break-words">
                <div>
                  <% 
                    parts = JSON.parse(message[:parts])
                    text_content = parts.map { |part| part['text'] }.compact.join(' ')
                    # Only convert newlines that aren't part of tables
                    unless text_content.include?('|')
                      text_content = text_content.gsub("\n", "\n\n")
                    end
                    renderer = Redcarpet::Render::HTML.new(filter_html: true, no_styles: true, safe_links_only: true)
                    markdown = Redcarpet::Markdown.new(renderer, autolink: true, tables: true, fenced_code_blocks: true, space_after_headers: true)
                    rendered_html = markdown.render(text_content)
                  %>
                  <%= rendered_html.gsub('&lt;', '<').gsub('&gt;', '>').gsub('&amp;', '&') %>
                </div>
              </div>
            </div>
          </div>
        <% end %>
      <% end %>
    <% end %>
    <!-- New messages will be inserted here -->
  </div>
</div>


<!-- Input Form - Sticky at bottom -->
<div class="sticky bottom-0 bg-white px-4 pb-6 pt-3">
  <div class="max-w-3xl mx-auto flex flex-col gap-2">

    <!-- Model Selector Row (above input) -->
    <!-- Add padding-top to the group to create an invisible bridge so the hover doesn't break when moving to the menu -->
    <div class="relative self-start group/model pt-4 -mt-4">
      <!-- Text Pill Button -->
      <div class="bg-white rounded-full shadow-sm border border-gray-200 px-3 py-1.5 flex items-center hover:shadow-md transition-all duration-300 cursor-pointer">
        <span id="selected-model-pill" class="text-gray-700 text-sm font-medium group-hover/model:text-blue-600 transition-colors">GLM-5</span>
        <svg class="w-3.5 h-3.5 text-gray-400 ml-1.5 group-hover/model:text-blue-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
        </svg>
      </div>

      <!-- Dropdown Menu — opens upward ON HOVER -->
      <!-- Uses opacity, visibility, and transform to slide up smoothly when hovering over the container -->
      <div class="absolute bottom-[calc(100%-8px)] left-0 mb-4 w-72 bg-white border border-gray-200 rounded-xl shadow-xl overflow-hidden z-[60] opacity-0 invisible translate-y-2 group-hover/model:opacity-100 group-hover/model:visible group-hover/model:translate-y-0 transition-all duration-200 pointer-events-none group-hover/model:pointer-events-auto">
        
        <!-- Header to show currently selected model inside the menu -->
        <div class="bg-gray-50 px-3 py-2.5 border-b border-gray-200">
          <div class="text-[10px] text-gray-500 font-semibold uppercase tracking-wider mb-0.5">Current Model</div>
          <div class="text-sm font-semibold text-gray-900" id="selected-model-display">GLM-5</div>
        </div>

        <div class="px-2 py-2 max-h-[320px] overflow-y-auto">

          <%
            # [id, display_name, tier, cost]
            models = [
              ['claude-opus-4-6',           'Claude Opus 4.6',    'pro',      5],
              ['openai/gpt-5.2-codex',      'GPT-5.2 Codex',      'pro',      5],
              ['capmap',                    'CapMap',             'advanced', 8],
              ['openai/gpt-5.2',            'GPT-5.2 (Base)',     'advanced', 3],
              ['claude-sonnet-4-6',         'Claude Sonnet 4.6',  'advanced', 3],
              ['gemini-3-pro',              'Gemini 3 Pro',       'advanced', 3],
              ['gemini-3.1-pro',            'Gemini 3.1 Pro',     'advanced', 3],
              ['openai/gpt-5.1-codex-max',  'GPT-5.1 Codex Max',  'advanced', 3],
              ['minimax/minimax-m2.5',      'MiniMax M2.5',       'advanced', 3],
              ['moonshotai/kimi-k2.5',      'Kimi K2.5',          'advanced', 3],
              ['gemini-3-flash',            'Gemini 3 Flash',     'free',     1],
              ['qwen/qwen3.5-plus-02-15',   'Qwen 3.5 Plus',      'free',     1],
              ['z-ai/glm-5',                'GLM-5',              'free',     1]
            ]

            tier_label = { 'free' => 'Free', 'advanced' => 'Advanced', 'pro' => 'Pro' }
            tier_rank = { 'free' => 0, 'advanced' => 1, 'pro' => 2 }

            acct = ((@current_user || {})[:account_type] || 'free').downcase
            user_rank = tier_rank[acct] || 0

            prev_tier = nil
          %>

          <% models.each do |id, name, tier, cost| %>
            <% if tier != prev_tier %>
              <%
                header_text = case tier
                  when 'pro'      then 'text-purple-600'
                  when 'advanced' then 'text-amber-600'
                  else                 'text-gray-400'
                end
              %>
              <div class="px-2 pt-3 pb-1 mt-1 first:mt-0 first:pt-1">
                <span class="text-[11px] font-bold uppercase tracking-wider <%= header_text %> opacity-80"><%= tier_label[tier] %></span>
              </div>
              <% prev_tier = tier %>
            <% end %>

            <%
              badge_classes = case tier
                when 'pro'      then 'bg-[#1a0a2e] text-[#c084fc] ring-1 ring-[#c084fc]/20'
                when 'advanced' then 'bg-amber-50 text-amber-700 ring-1 ring-amber-200/50'
                else                 'bg-gray-50 text-gray-500 ring-1 ring-gray-200'
              end

              is_locked = tier_rank[tier] > user_rank
              btn_classes = if is_locked
                "w-full text-left px-2.5 py-2 text-sm flex items-center justify-between gap-2 opacity-50 hover:bg-red-50 transition-colors duration-150 rounded-lg group"
              else
                "w-full text-left px-2.5 py-2 text-sm flex items-center justify-between gap-2 hover:bg-gray-100/80 transition-colors duration-150 rounded-lg group"
              end
              btn_action = is_locked ? "window.location='/plans'" : "document.getElementById('model-input').value='#{id}'; document.getElementById('selected-model-display').innerText='#{name.gsub("'", "\\\\'")}'; document.getElementById('selected-model-pill').innerText='#{name.gsub("'", "\\\\'")}'" 
            %>
            <button type="button"
                    class="<%= btn_classes %>"
                    onclick="<%= btn_action %>"
                    title="<%= is_locked ? "Requires upgrade to #{tier_label[tier]}" : "#{cost} req" %>">
              <!-- Model name -->
              <span class="text-gray-700 font-medium <%= is_locked ? 'group-hover:text-red-700' : 'group-hover:text-blue-600' %> transition-colors flex-1 truncate">
                <%= name %>
                <% if is_locked %>
                  <svg class="inline w-3 h-3 text-red-400 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                <% end %>
              </span>
              <!-- Cost chip -->
              <span class="text-[10px] font-semibold text-gray-400 flex-shrink-0 tabular-nums"><%= cost %>cr</span>
            </button>
          <% end %>

        </div>
      </div>
    </div>

    <!-- Chat Form — full width below model selector -->
    <form class="relative w-full"
          hx-post="/chat/messages"
          hx-target=".container"
          hx-swap="beforeend"
          hx-on::after-request="document.getElementById('welcome-section')?.remove(); document.getElementById('message-input').value = ''">
      <input class="w-full pl-5 pr-14 py-3.5 border border-gray-300 rounded-full bg-white text-gray-700 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-200 focus:border-gray-400 shadow-sm text-base transition-shadow duration-200"
             name="message"
             type="text"
             placeholder="Send a message..."
             id="message-input"
             autocomplete="off"/>
      <input type="hidden" name="model" id="model-input" value="z-ai/glm-5"/>
      <button class="absolute right-2 top-1/2 transform -translate-y-1/2 w-9 h-9 bg-black hover:scale-105 active:scale-95 text-white rounded-full flex items-center justify-center transition-all duration-200 shadow-md"
              type="submit"
              id="send-button">
        <svg class="w-4 h-4 ml-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/>
        </svg>
      </button>

      <!-- Stop Button (Hidden by default) -->
      <button class="absolute right-2 top-1/2 transform -translate-y-1/2 w-9 h-9 bg-black hover:bg-gray-800 text-white rounded-full flex items-center justify-center transition-all duration-200 shadow-md hidden"
              type="button"
              onclick="stopGeneration()"
              id="stop-button">
        <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 24 24">
          <path d="M6 6h12v12H6z"/>
        </svg>
      </button>
    </form>

  </div>
</div>

<!-- Account Widget - Bottom Left -->
<% if @current_user %>
  <%
    account_type = (@current_user[:account_type] || 'free').downcase
    
    # Avatar gradient based on account type
    avatar_class = case account_type
      when 'advanced' then 'avatar-golden'
      when 'pro' then 'avatar-diamond'
      else 
        # Free users get random gradient
        email_hash = @current_user[:email].bytes.sum
        hue1 = (email_hash * 137) % 360
        hue2 = (hue1 + 60) % 360
        nil
    end
    
    avatar_style = avatar_class ? '' : "background: linear-gradient(135deg, hsl(#{((@current_user[:email].bytes.sum * 137) % 360)}, 70%, 60%), hsl(#{(((@current_user[:email].bytes.sum * 137) % 360) + 60) % 360}, 75%, 65%))"
    
    # Account type badge colors
    badge_colors = {
      'free' => 'bg-gray-100 text-gray-700 border-gray-200',
      'advanced' => 'bg-gradient-to-r from-yellow-400 to-orange-500 text-white border-transparent',
      'pro' => 'bg-gradient-to-r from-blue-400 to-cyan-300 text-gray-900 border-transparent'
    }
    badge_class = badge_colors[account_type] || badge_colors['free']
  %>
  
  <div class="fixed bottom-6 left-4 sm:left-6 z-50 group" id="account-widget">
    <!-- Smooth width transition. Closed state: 64px wide (just enough for 48px avatar + 8px padding * 2). Open/XL state: 280px -->
    <div class="bg-white/95 backdrop-blur-sm rounded-full xl:rounded-2xl shadow-lg border border-gray-200 p-2 flex items-center hover:shadow-xl transition-all duration-300 w-[64px] xl:w-[280px] group-hover:w-[280px] group-hover:rounded-2xl overflow-hidden cursor-pointer"
         onclick="this.classList.toggle('w-[280px]')">
      
      <!-- Avatar Circle with Gradient -->
      <div class="relative flex-shrink-0">
        <div id="user-avatar" class="w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-lg shadow-sm <%= avatar_class %>" 
             style="<%= avatar_style %>">
          <%= @current_user[:email][0].upcase %>
        </div>
        <!-- Online indicator -->
        <div class="absolute bottom-0 right-0 w-3.5 h-3.5 bg-green-500 border-2 border-white rounded-full"></div>
      </div>
      
      <!-- Content Container (fixed width so it doesn't wrap during transition) -->
      <div class="flex items-center gap-3 pl-3 w-[200px] flex-shrink-0 opacity-0 xl:opacity-100 group-hover:opacity-100 transition-opacity duration-300">
        
        <!-- User Info -->
        <div class="flex-1 min-w-0">
          <div class="flex items-center gap-2">
            <div class="text-sm font-semibold text-gray-900 truncate">
              <%= @current_user[:email] %>
            </div>
            <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider border <%= badge_class %> flex-shrink-0">
              <%= account_type %>
            </span>
          </div>
          <% if @request_info %>
            <%
              pct       = ((@request_info[:count].to_f / @request_info[:limit]) * 100).round
              remaining = @request_info[:remaining]
              bar_color  = pct >= 80 ? '#ef4444' : pct >= 50 ? '#f59e0b' : '#22c55e'
              text_color = pct >= 80 ? 'color:#ef4444' : pct >= 50 ? 'color:#f59e0b' : 'color:#6b7280'
            %>
            <div class="mt-1.5">
              <div class="flex justify-between items-center mb-1">
                <span class="text-[9px] font-medium" style="<%= text_color %>">
                  <%= remaining %> / <%= @request_info[:limit] %> requests left
                </span>
              </div>
              <div class="w-full h-1 bg-gray-100 rounded-full overflow-hidden">
                <div class="h-full rounded-full transition-all duration-500"
                     style="width:<%= [pct, 100].min %>%; background:<%= bar_color %>;"></div>
              </div>
            </div>
          <% end %>
          <% if account_type == 'free' %>
            <a href="/plans" class="mt-2 block">
              <button id="upgrade-btn"
                      class="upgrade-cta-btn w-full flex items-center justify-center gap-1.5 px-2 py-1 rounded-md text-[11px] font-semibold text-white transition-all duration-200 hover:opacity-90 hover:scale-[1.02] active:scale-[0.98]"
                      style="background: linear-gradient(135deg, #f59e0b 0%, #ef4444 60%, #8b5cf6 100%); box-shadow: 0 2px 8px rgba(245,158,11,0.35);">
                <svg class="w-3 h-3 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                </svg>
                Upgrade Plan
              </button>
            </a>
          <% else %>
            <form action="/billing" method="POST" class="mt-2 text-center relative z-10">
              <button type="submit" id="manage-plan-btn"
                      class="upgrade-cta-btn w-full flex items-center justify-center gap-1.5 px-2 py-1 rounded-md text-[11px] font-semibold text-white transition-all duration-200 hover:opacity-90 hover:scale-[1.02] active:scale-[0.98]"
                      style="background: <%= account_type == 'pro' ? 'linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%)' : 'linear-gradient(135deg, #fbbf24 0%, #f97316 100%)' %>; box-shadow: 0 2px 8px rgba(99,102,241,0.3);">
                <svg class="w-2.5 h-2.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                Manage
              </button>
            </form>
          <% end %>
        </div>
        
        <!-- Settings Icon -->
        <a href="/logout" class="flex-shrink-0 p-1.5 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors duration-200 relative z-10" title="Logout">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
          </svg>
        </a>

      </div>
    </div>
  </div>
<% end %>

<!-- Upgrade Celebration Overlay (hidden by default) -->
<div id="upgrade-overlay" class="upgrade-overlay" style="display: none;">
  <div id="premium-ball" class="premium-ball golden">
    <span id="ball-letter"><%= @current_user ? @current_user[:email][0].upcase : '★' %></span>
  </div>
</div>

<script>
// Check for upgrade parameter
(function() {
  const urlParams = new URLSearchParams(window.location.search);
  const upgradePlan = urlParams.get('upgrade');
  
  if (upgradePlan && (upgradePlan === 'advanced' || upgradePlan === 'pro')) {
    // Start the celebration!
    startUpgradeCelebration(upgradePlan);
    
    // Clean the URL
    window.history.replaceState({}, document.title, window.location.pathname);
  }
})();

function startUpgradeCelebration(plan) {
  const overlay = document.getElementById('upgrade-overlay');
  const ball = document.getElementById('premium-ball');
  const mainContent = document.querySelector('body');
  const avatar = document.getElementById('user-avatar');
  
  if (!overlay || !ball) return;
  
  // Set ball type (golden or diamond)
  ball.classList.remove('golden', 'diamond');
  ball.classList.add(plan === 'pro' ? 'diamond' : 'golden');
  
  // Blur main content
  if (mainContent) mainContent.classList.add('upgrade-blur');
  
  // Show overlay
  overlay.style.display = 'flex';
  
  // After expand animation (2.5s), start smash
  setTimeout(() => {
    ball.classList.add('smashing');
    
    // After smash (0.8s), do impact and cleanup
    setTimeout(() => {
      // Flash the avatar
      if (avatar) {
        avatar.classList.add('avatar-impact');
        avatar.classList.add(plan === 'pro' ? 'avatar-diamond' : 'avatar-golden');
      }
      
      // Hide overlay
      overlay.style.display = 'none';
      
      // Remove blur
      if (mainContent) mainContent.classList.remove('upgrade-blur');
      
      // Reset ball for next time
      ball.classList.remove('smashing');
      
    }, 800);
  }, 2500);
}
</script>

<script>
let currentEventSource = null;
let statusInterval = null;

// (model dropdown is hover-based; no click handler needed)

// Stop generation logic
function stopGeneration() {
  if (currentEventSource) {
    currentEventSource.close();
    currentEventSource = null;
  }
  
  if (statusInterval) {
    clearInterval(statusInterval);
    statusInterval = null;
  }
  
  // Toggle buttons back
  document.getElementById('stop-button').classList.add('hidden');
  document.getElementById('send-button').classList.remove('hidden');
  
  // Clean up any remaining loading indicators
  const dots = document.querySelectorAll('.typing-bubble');
  dots.forEach(d => d.parentElement.innerHTML = '<span class="text-xs text-gray-500 italic">Generation stopped.</span>');
}

function startAIStream(aiResponse, aiId) {
  // Show Stop button, hide Send button
  document.getElementById('send-button').classList.add('hidden');
  document.getElementById('stop-button').classList.remove('hidden');

  const container = document.getElementById(aiId);
  if (!container) return; // Safety check

  // ---------------------------------------------------------
  // CLIENT-SIDE PATCH FOR LEGACY SERVER HTML (No Restart Fix)
  // ---------------------------------------------------------
  
  // 1. Remove rotating animation classes immediately
  const avatarContainer = container.querySelector('.ai-avatar-container');
  if (avatarContainer) {
      avatarContainer.classList.remove('ai-loading');
      const img = avatarContainer.querySelector('img');
      if (img) img.classList.remove('logo-loading');
      avatarContainer.style.display = 'flex';
  }

  // 2. Replace "AI is thinking..." with new Status UI if present
  const oldIndicator = container.querySelector('.typing-indicator');
  let statusText = null;

  if (oldIndicator) {
      // We are running on old server HTML. Replace it dynamically.
      const wrapper = oldIndicator.parentElement;
      wrapper.innerHTML = `
        <div class="inline-block px-4 py-3 bg-gray-100 rounded-2xl rounded-tl-none">
            <div class="flex items-center gap-3">
                <div class="typing-bubble">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
                <span class="text-xs font-medium text-gray-500 status-text">Analyzing Request...</span>
            </div>
        </div>
      `;
      // Re-query the new status text element
      statusText = wrapper.querySelector('.status-text');
  } else {
      // We might be on new HTML, start looking for status text normally
      statusText = container.querySelector('.status-text');
  }
  
  // ---------------------------------------------------------

  const aiContent = container.querySelector('.text-gray-900 div');

  // Start cycling status text
  const statuses = ["Analyzing Request...", "Searching Knowledge Base...", "Formulating Response...", "Thinking...", "Synthesizing Answer..."];
  let statusIndex = 0;
  
  // Update every 5 seconds as requested
  statusInterval = setInterval(() => {
    if (statusText) {
        statusIndex = (statusIndex + 1) % statuses.length;
        statusText.textContent = statuses[statusIndex];
    }
  }, 5000);

  const eventSource = new EventSource('/chat/stream/' + aiId);
  currentEventSource = eventSource;
  
  let accumulatedContent = '';
  let hasStarted = false;

  eventSource.onmessage = function(event) {
    if (!hasStarted) {
        // First token received: clear interval, clear placeholder, ready for text
        if (statusInterval) clearInterval(statusInterval);
        // Clear the entire wrapper logic we might have injected
        aiContent.innerHTML = ''; 
        hasStarted = true;
    }
    
    accumulatedContent += event.data;
    // Show accumulated content as HTML
    aiContent.innerHTML = accumulatedContent;
  };

  eventSource.addEventListener('complete', function(event) {
    aiContent.innerHTML = accumulatedContent;
    eventSource.close();
    currentEventSource = null;
    
    if (statusInterval) clearInterval(statusInterval);
    
    // Reset buttons
    document.getElementById('stop-button').classList.add('hidden');
    document.getElementById('send-button').classList.remove('hidden');
  });

  eventSource.onerror = function(error) {
    console.error('SSE error:', error);
    if (statusInterval) clearInterval(statusInterval);
    
    aiContent.textContent = 'Error loading response';
    eventSource.close();
    currentEventSource = null;
    
    document.getElementById('stop-button').classList.add('hidden');
    document.getElementById('send-button').classList.remove('hidden');
  };
}
</script>
  </div>
</div>

</div>

<!-- Feedback Modal -->
<div id="feedback-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4">
  <!-- Backdrop -->
  <div class="absolute inset-0 bg-black/30 backdrop-blur-sm" onclick="document.getElementById('feedback-modal').classList.add('hidden')"></div>
  
  <!-- Card -->
  <div class="relative bg-white rounded-2xl shadow-2xl border border-gray-100 w-full max-w-md p-6">
    <button class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors" onclick="document.getElementById('feedback-modal').classList.add('hidden')">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
    </button>

    <h3 class="text-base font-bold text-gray-900 mb-1">Send Feedback</h3>
    <p class="text-sm text-gray-500 mb-4">Report a bug, request a feature, or share anything on your mind.</p>

    <div id="feedback-success" class="hidden mb-4 px-3 py-2.5 bg-green-50 border border-green-200 rounded-lg text-sm text-green-700 font-medium">Thanks! We got your feedback ✓</div>
    <div id="feedback-error" class="hidden mb-4 px-3 py-2.5 bg-red-50 border border-red-200 rounded-lg text-sm text-red-700 font-medium">Something went wrong. Please try again.</div>

    <textarea id="feedback-note"
              class="w-full h-28 px-3 py-2.5 text-sm border border-gray-200 rounded-xl resize-none focus:outline-none focus:ring-2 focus:ring-blue-200 focus:border-blue-400 text-gray-700 placeholder-gray-400 transition"
              placeholder="Describe the bug or feature you'd like..."></textarea>

    <button onclick="submitFeedback()"
            class="mt-3 w-full py-2.5 rounded-xl text-sm font-semibold text-white bg-gray-900 hover:bg-gray-700 active:scale-[0.98] transition-all duration-200">
      Send
    </button>
  </div>
</div>

<script>
function submitFeedback() {
  const note = document.getElementById('feedback-note').value.trim();
  const success = document.getElementById('feedback-success');
  const error   = document.getElementById('feedback-error');
  success.classList.add('hidden');
  error.classList.add('hidden');
  if (!note) return;

  fetch('/feedback', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: 'note=' + encodeURIComponent(note)
  })
  .then(r => {
    if (r.ok) {
      success.classList.remove('hidden');
      document.getElementById('feedback-note').value = '';
      setTimeout(() => document.getElementById('feedback-modal').classList.add('hidden'), 1800);
    } else {
      error.classList.remove('hidden');
    }
  })
  .catch(() => error.classList.remove('hidden'));
}
</script>

</body>